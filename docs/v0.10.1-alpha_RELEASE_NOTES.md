# RAG-KB v0.10.1-alpha Release Notes

Release Date: 2025-11-20

## Overview

This release introduces concurrent processing, priority-based queue management, and significant performance improvements. Processing throughput has improved 4x for large document queues through parallel embedding workers.

## Major Features

### 1. Concurrent Processing Pipeline

Implemented a 3-stage concurrent pipeline for document processing:
- **ChunkWorker**: Extracts text and chunks documents
- **EmbedWorkerPool**: Parallel embedding workers (configurable, default: 3 workers)
- **StoreWorker**: Database persistence

**Benefits**:
- 4x throughput improvement for large document queues
- Non-blocking extraction and chunking
- Configurable parallelism via `EMBED_WORKERS` environment variable

**Architecture**:
```
IndexingQueue (Priority) → IndexingWorker → PipelineCoordinator
                                              ↓
                                      ChunkWorker (1 thread)
                                              ↓
                                      EmbedWorkerPool (3 threads)
                                              ↓
                                      StoreWorker (1 thread)
```

### 2. Priority-Based Queue System

- HIGH priority for orphan repair and data integrity
- NORMAL priority for new file indexing
- Ensures critical files process first
- Queue management API endpoints for monitoring

### 3. Sanitization Stage

Pre-indexing validation and cleanup:
- Orphan detection and automatic repair
- File hash validation
- Automatic recovery from inconsistent states
- Runs before background indexing starts

### 4. Enhanced Queue Management API

**New Endpoints**:

**GET `/queue/jobs`** - Monitor queue and worker status
```json
{
  "queue_sizes": {
    "chunk": 1546,
    "embed": 10,
    "store": 0
  },
  "active_jobs": {
    "chunk": "document.pdf",
    "embed": ["doc1.md", "doc2.md", "doc3.md"],
    "store": null
  },
  "workers_running": {
    "chunk": true,
    "embed": true,
    "store": true
  }
}
```

**POST `/indexing/pause`** - Pause queue processing  
**POST `/indexing/resume`** - Resume queue processing  
**POST `/indexing/clear`** - Clear pending queue  
**POST `/orphans/repair`** - Queue orphaned files for reindexing

## Performance Improvements

### Throughput
- **Before**: ~2 files/hour for large PDFs (sequential processing)
- **After**: ~8 files/hour (4x improvement with 3 embedding workers)

### Resource Utilization
- Better CPU utilization with parallel embedding
- Non-blocking extraction allows continuous file processing
- Queue-based throttling prevents memory exhaustion

## Configuration

### New Environment Variables

```bash
# Concurrent processing
EMBED_WORKERS=3          # Number of parallel embedding threads (default: 3)

# Model configuration
EMBEDDING_MODEL=Snowflake/snowflake-arctic-embed-l
EMBEDDING_DIMENSION=1024
```

## API Enhancements

### Queue Management
- Monitor queue sizes and active jobs
- Pause/resume indexing
- Clear pending queue
- Orphan repair endpoint

### Document Management
- Enhanced delete endpoint with full cleanup
- Document search by pattern
- Improved error handling and reporting

## Architecture Changes

### New Modules
- `api/services/pipeline_coordinator.py` - Concurrent pipeline orchestration
- `api/services/pipeline_queues.py` - Queue data structures
- `api/services/pipeline_workers.py` - Worker thread management
- `api/services/embedding_service.py` - Embedding coordination
- `api/services/indexing_queue.py` - Priority queue implementation
- `api/services/indexing_worker.py` - Background indexing worker
- `api/ingestion/document_repository.py` - Document operations
- `api/ingestion/chunk_repository.py` - Chunk operations
- `api/ingestion/search_repository.py` - Search operations
- `api/orchestration/file_discovery.py` - File scanning
- `api/orchestration/progress_reporter.py` - Progress tracking

### Improved Structure
- Separated concerns into focused modules
- Service layer for concurrent operations
- Repository pattern for data access
- Clear separation of orchestration logic

## Breaking Changes

None. All changes are backward compatible.

## Bug Fixes

1. Fixed orphan repair bypass of queue system
2. Corrected pipeline stage naming for clarity
3. Fixed FileHasher import issues
4. Resolved queue reference issues in endpoint handlers
5. Improved worker monitoring visibility

## Known Issues

1. Test suite requires pytest installation in Docker
2. Some repository classes have high method counts (acceptable for CRUD operations)

## Migration Guide

### From v0.9.1-alpha

No migration required. The concurrent pipeline activates automatically with existing configuration.

### Optional Tuning

Adjust concurrent workers based on CPU cores:
```bash
# For 8-core machine
EMBED_WORKERS=6

# For 4-core machine
EMBED_WORKERS=3
```

## Compatibility

- Python 3.8+
- No new dependencies added
- Existing configuration unchanged
- Docker image compatible

## Documentation

- Updated ROADMAP.md with future improvements
- Enhanced API documentation for new endpoints
- Added architecture documentation

---

For questions or issues, please open a GitHub issue.
