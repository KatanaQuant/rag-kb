# v2.2.1 Release Plan: HNSW Persistence Fix

## Critical Bug Fixed

v2.2.0-beta introduced a critical bug where newly indexed documents were not persisted to the HNSW vector index. Documents appeared to index successfully but were not searchable, and were lost on container restart.

**Root Cause**: vectorlite only saves the HNSW index when the database connection closes. The API kept connections open indefinitely.

**Fix**: Close and reopen connection after each document store to force index persistence.

---

## What's Broken for v2.2.0-beta Users

Users who:
1. Upgraded to v2.2.0-beta
2. Indexed new documents after upgrade
3. Have NOT restarted their container

**Will have**:
- Documents in `chunks` table
- Missing entries in `vec_chunks` (HNSW index)
- Documents not searchable

---

## Release Components

### 1. Core Fix (already implemented)

**File**: `api/ingestion/database.py`

```python
def add_document(self, file_path, file_hash, chunks, embeddings):
    self.repo.add_document(file_path, file_hash, chunks, embeddings)
    self._flush_hnsw_index()  # <-- NEW

def _flush_hnsw_index(self):
    """Force HNSW index to persist by closing and reopening connection."""
    self.conn.close()
    self.conn = self.db_conn.connect()
    self.repo = VectorRepository(self.conn)
    self.hybrid = HybridSearcher(self.conn)
```

### 2. Self-Healing Stage Enhancement (TODO)

**File**: `api/startup/phases/sanitization_phase.py`

Add detection and repair of orphaned chunks:

```python
async def _repair_hnsw_orphans(self):
    """Find chunks missing from HNSW index and re-embed them."""
    # Get all chunk IDs from chunks table
    # Check which are missing from vec_chunks
    # Re-embed and insert missing ones
    # Or: trigger force-reindex for affected documents
```

### 3. Repair Script for Manual Fix (TODO)

**File**: `api/ingestion/repair_hnsw.py`

```python
def repair_hnsw_index(db_path: str):
    """
    Repair HNSW index by finding chunks missing from vec_chunks
    and re-embedding them.

    Usage:
        docker exec rag-api python /app/ingestion/repair_hnsw.py /app/data/rag.db
    """
```

### 4. Migration Script Update (TODO)

**File**: `api/ingestion/vector_migration.py`

The migration script is fine, but add documentation:

```python
"""
IMPORTANT: This script is for one-time migration from sqlite-vec to vectorlite.
It is NOT needed if you're already on vectorlite (v2.2.0+).

If you have orphaned chunks (indexed after v2.2.0-beta upgrade but not searchable),
use repair_hnsw.py instead.
"""
```

---

## User Communication

### Changelog Entry

```markdown
## v2.2.1 - HNSW Persistence Fix

### Critical Bug Fix
- **Fixed**: Documents indexed after v2.2.0-beta upgrade were not persisted to HNSW index
- Documents appeared to index successfully but were not searchable
- On container restart, newly indexed documents were lost from search

### Root Cause
vectorlite only saves the HNSW index when the database connection closes.
The API kept connections open indefinitely, so inserts went to in-memory index only.

### Fix
Connection is now closed and reopened after each document store to force persistence.

### If You're Affected
If you upgraded to v2.2.0-beta and indexed documents that aren't searchable:

1. **Quick fix**: Force reindex affected documents via API
   ```bash
   curl -X POST "http://localhost:8000/reindex?path=/path/to/file.pdf&force=true"
   ```

2. **Full repair**: Run the repair script
   ```bash
   docker exec rag-api python /app/ingestion/repair_hnsw.py /app/data/rag.db
   ```

3. **Nuclear option**: Re-run migration (rebuilds entire HNSW index)
   ```bash
   docker exec rag-api python /app/ingestion/vector_migration.py /app/data/rag.db
   ```
```

---

## Testing Checklist

- [ ] New documents persist after indexing
- [ ] Documents survive container restart
- [ ] Query returns results from newly indexed documents
- [ ] Repair script fixes orphaned chunks
- [ ] Self-healing stage detects and repairs orphans on startup
- [ ] Migration script still works for fresh installs

---

## Backlog Items

### P1: Implement repair_hnsw.py script
Allows users to fix corrupted DBs without full re-migration.

### P2: Enhance self-healing stage
Auto-detect and repair HNSW orphans on startup.

### P3: Research alternative vector stores
Current setup is "quirky" - vectorlite's save-on-close behavior is unusual.
Alternatives to evaluate:
- sqlite-vec (slower but simpler)
- Qdrant (dedicated vector DB)
- Milvus (cloud-native)
- LanceDB (embedded, Rust-based)

### P4: Consolidate sync/async stores
Consider async-only architecture for simplicity, though current design works.

---

## Files Changed in v2.2.1

| File | Change |
|------|--------|
| `api/ingestion/database.py` | Added `_flush_hnsw_index()` after `add_document()` |
| `api/ingestion/chunk_repository.py` | Added error logging for HNSW insert failures |
| `api/ingestion/async_repositories.py` | Added logging (future-proofing) |
| `docs/postmortem-hnsw-index-not-persisting.md` | Full incident documentation |
| `docs/v2.2.1-release-plan.md` | This file |
