# Release v1.6.7 - Security Hardening & Quality Improvements

**Release Date:** November 27, 2025
**Previous Public Release:** v1.0.0 (January 2025)

## Overview

Major security and quality improvements since v1.0.0. This release focuses on comprehensive malware detection, production-ready security features, performance optimizations, and codebase quality improvements.

**Highlights:**
- Complete malware detection system (ClamAV + YARA + hash blacklist)
- Security REST API with parallel scanning
- Production-grade monitoring and maintenance APIs
- Significant performance optimizations (1300x faster integrity checks)
- Sandi Metz OOP audit for code quality
- Critical security bug fixes
- MCP setup guides for Claude, Codex, and Gemini

---

## What's New Since v1.0.0

### Security Features (v1.1.0 - v1.6.7)

#### Advanced Malware Detection (v1.5.0)
Three-layer security validation:
- **ClamAV integration**: Virus signature scanning (CRITICAL severity)
- **YARA rules**: Custom pattern matching for suspicious content
- **Hash blacklist**: Known malware SHA256 database

**Configuration** (enabled by default):
```bash
CLAMAV_ENABLED=true
YARA_ENABLED=true
HASH_BLACKLIST_ENABLED=true
```

#### Quarantine System (v1.4.0)
Automatic quarantine of dangerous files:
- Malware detected by ClamAV
- Files matching YARA critical patterns
- Executables masquerading as documents
- Archive bombs and compression attacks

Files moved to `.quarantine/` with metadata tracking.

#### Rejection Tracking (v1.3.0)
Database tracking of all rejected files:
- Validation failure reasons
- File hashes for deduplication
- Rejection timestamps
- Validation check identifiers

#### Security REST API (v1.6.0)
Background security scanning with job tracking:

```bash
# Start retroactive scan
POST /api/security/scan
Response: {"job_id": "8dc87920", "status": "pending"}

# Check progress
GET /api/security/scan/8dc87920
Response: {"status": "running", "progress": 1500, "total_files": 2871}

# Single-file scan (v1.6.7)
POST /api/security/scan/file?file_path=test.pdf
Response: {"status": "clean", "threats_found": 0, "scan_time_ms": 29}
```

**Performance:**
- Parallel scanning with 8 workers (~100x faster)
- Result caching by file hash
- Non-blocking API (immediate job ID)
- 9-29ms scan time for single files

**Endpoints:**
- `POST /api/security/scan` - Scan all files
- `GET /api/security/scan/{job_id}` - Check progress
- `GET /api/security/scan` - List all jobs
- `POST /api/security/scan/file` - Scan single file (v1.6.7)
- `GET /api/security/quarantine` - List quarantined files
- `POST /api/security/quarantine/restore` - Restore file
- `POST /api/security/quarantine/purge` - Purge old files
- `GET /api/security/rejected` - List rejected files
- `GET /api/security/cache/stats` - Cache statistics
- `DELETE /api/security/cache` - Clear cache

#### File Type Validation (v1.2.0)
Pre-processing security checks:
- Magic byte verification (file matches extension)
- Executable detection (ELF, PE, Mach-O, shell scripts)
- Archive bomb detection (compression ratio limits)
- Extension mismatch detection (malware masquerading)
- File size limits (prevent DoS)

### Document Integrity & Completeness (v1.1.0)

#### PDF Integrity Validation
5-point validation system:
1. Valid PDF header (`%PDF-`)
2. EOF marker present
3. xref table structure
4. Trailer dictionary
5. Page count validation

**API:**
```bash
GET /documents/integrity
Response: {
  "total_documents": 1628,
  "complete": 1620,
  "incomplete": 8,
  "incomplete_documents": [...]
}
```

#### Completeness Checking
Strategy-based validation:
- Chunk count verification
- Embedding count verification
- Processing status validation
- Database chunk existence (orphan detection)

**Self-healing:**
- Auto-repair empty document records
- Backfill missing chunk counts
- Orphan file detection and reindexing

### Performance Improvements

#### v1.6.2: Integrity API Optimization
**Problem:** `/documents/integrity` took ~3 minutes for 1300 docs (N+1 query)

**Fix:** Batch preloading with SQLAlchemy relationships

**Result:** 1300x faster (180s → <1s)

#### v1.6.5: CPU-Optimized Defaults
Changed `EMBEDDING_WORKERS` default from 3 to 2 for CPU environments.

**Guidance:**
- **CPU**: 2 workers (prevent thrashing)
- **GPU**: 4-8 workers (maximize throughput)

### Code Quality (v1.6.6)

#### Sandi Metz OOP Audit
Comprehensive refactoring following Practical Object-Oriented Design principles:

**Complexity Reduction:**
- `_run_scan_job`: D(30) → A(4) via SecurityScanner extraction
- `reindex_failed_documents`: C(15) → A(4) via FailedDocumentReindexer
- `PDFIntegrityValidator.validate`: C(14) → A(2.33) via ValidationChain
- `YARAStrategy.validate`: C(11) → A(4) via helper method extraction

**Architecture:**
- Zero C+ complexity functions (was 4)
- Average complexity: A (2.06)
- Law of Demeter fixes (removed train wrecks)

**New Files:**
- `api/pipeline/security_scanner.py` - SecurityScanner + 6 helpers
- `api/operations/failed_document_reindexer.py`
- `api/routes/deps.py` - Dependency injection helpers

### Codebase Organization (v1.6.5)

#### Directory Restructuring
Clear separation of concerns:
- `services/` → `pipeline/` (background processing: Chunk→Embed→Store)
- `api_services/` → `operations/` (API operations: Query/List/Search)

#### Code Cleanup
- Removed duplicate classes from routes (Single Responsibility)
- Deleted dead code (`state/app_state.py`)
- Routes now only contain HTTP handlers

### Bug Fixes

#### v1.6.7: Security Validation Bug (CRITICAL)
**Problem:** Malware files were warned but still indexed (not rejected)

**Root Cause:** Config mismatch
- `config.py` default: `"reject"` (changed in v1.3.0)
- `environment_config_loader.py` default: `"warn"` (outdated)

**Fix:** Updated environment loader to `"reject"`

**Impact:**
- Malware now correctly rejected and quarantined
- EICAR test file properly quarantined with ClamAV detection
- Full scan: 2,871 files, 0 false positives

#### v1.6.3: ClamAV Socket Contention
**Problem:** Parallel scanning (8 workers) caused "Bad file descriptor" errors

**Fix:** Thread-local ClamAV connections (one per worker)

#### v1.6.1: YARA Validation Logic
**Problem:** YARA `is_valid` logic inverted

**Fix:** Corrected boolean logic in YARAStrategy

### Removed Features

#### v1.6.3: manage.py CLI
**Reason:** Redundant - all functionality available via REST API

**Migration:**
- `manage.py scan-existing` → `POST /api/security/scan`
- `manage.py health` → `GET /health`
- Maintenance commands → `POST /api/maintenance/*`

---

## Breaking Changes

**None.** All changes are backwards-compatible.

---

## Upgrade Instructions

### From v1.0.0 (Last Public Release)

```bash
# Backup your data
docker-compose exec rag-api python3 -c "from config import default_config; import shutil; shutil.copytree(default_config.paths.knowledge_base, '/tmp/kb_backup')"

# Stop services
docker-compose down

# Pull latest
git pull origin main

# Rebuild (required for ClamAV databases)
docker-compose build --no-cache

# Start services
docker-compose up -d

# Verify health
curl http://localhost:8000/health

# Run security scan (recommended)
curl -X POST http://localhost:8000/api/security/scan
```

**No database migration required** - self-healing startup handles schema updates.

### New Configuration Options

All optional - sensible defaults provided:

```bash
# Security (all enabled by default)
CLAMAV_ENABLED=true
CLAMAV_SOCKET=/var/run/clamav/clamd.ctl
YARA_ENABLED=true
YARA_RULES_PATH=/app/yara_config/yara_rules.yar
HASH_BLACKLIST_ENABLED=true
HASH_BLACKLIST_PATH=/app/data/malware_hashes.txt

# Validation (reject by default since v1.3.0)
FILE_TYPE_VALIDATION_ENABLED=true
FILE_TYPE_VALIDATION_ACTION=reject  # reject|warn|skip

# Performance
EMBEDDING_WORKERS=2  # CPU-optimized (was 3)
```

---

## Testing

### Test Suite Status
- **638 tests passing**
- **15 skipped** (Docker-specific)
- **Zero failures**

### E2E Validation (v1.6.7)
Full deployment rollout test:
- All filetypes (.go, .py, .md, .ipynb, .pdf, .epub)
- Delete/re-index workflow
- EICAR malware detection and quarantine
- Full security scan: 2,871 files, 0 false positives
- Clean logs, no errors/warnings

---

## Known Issues

### Slow Markdown File Processing
Some `.md` files take significantly longer to embed than other formats (2+ hours for large files). Under investigation.

**Workaround:** Process markdown files separately or increase `EMBEDDING_WORKERS` temporarily.

### Empty Files Generate Warnings
Empty files produce security warnings during scans. This is intentional but may be noisy.

**Workaround:** Filter warnings or remove empty placeholder files.

---

## Performance Metrics

### Security Scanning
- **Throughput:** 143 files/second (parallel mode, 8 workers)
- **Single file:** 9-29ms (ClamAV + YARA + hash blacklist)
- **Full scan (2,871 files):** ~20 seconds

### API Response Times
- `/health`: <100ms
- `/documents/integrity`: <1s (was 180s in v1.0.0)
- `/query`: 100-500ms (vector similarity)
- `/api/security/scan`: <50ms (non-blocking, returns job ID)

---

## Migration Guide

### API Changes
No breaking changes. New endpoints added:

**Security:**
- `POST /api/security/scan` - Background scan
- `POST /api/security/scan/file` - Single file scan (v1.6.7)
- `GET /api/security/quarantine` - List quarantined
- `POST /api/security/quarantine/restore` - Restore file

**Integrity:**
- `GET /documents/integrity` - Check completeness (renamed from `/documents/completeness` in v1.6.2)

**Maintenance:**
- `POST /api/maintenance/reindex-orphaned-files`
- `POST /api/maintenance/cleanup-empty-documents`

### Configuration Changes
All optional - defaults work for most use cases:

**v1.3.0:** `FILE_TYPE_VALIDATION_ACTION` default changed from `warn` to `reject`
**Impact:** Malware files now auto-quarantined (was only warned)

**v1.6.5:** `EMBEDDING_WORKERS` default changed from `3` to `2`
**Impact:** Better CPU performance, lower memory usage

---

## Full Changelog

**v1.6.7** (Nov 27, 2025)
- Fix: validation_action config mismatch (critical security bug)
- Add: POST /api/security/scan/file endpoint
- Add: MCP_CLAUDE.md (renamed from MCP_INTEGRATION.md)
- Add: MCP_CODEX.md for OpenAI Codex MCP setup
- Add: MCP_GEMINI.md for Google Gemini MCP setup
- Docs: All MCP guides have consistent structure (CLI install, setup, manual config, prioritize KB)
- E2E: Full deployment validation passed

**v1.6.6** (Nov 26, 2025)
- Refactor: Sandi Metz OOP audit (complexity reduction)
- Zero C+ complexity functions
- Law of Demeter fixes

**v1.6.5** (Nov 26, 2025)
- Refactor: services/ → pipeline/, api_services/ → operations/
- Change: EMBEDDING_WORKERS default 3 → 2
- Remove: Duplicate classes from routes

**v1.6.3** (Nov 25, 2025)
- Fix: ClamAV socket contention (thread-local connections)
- Remove: manage.py CLI (use REST API)

**v1.6.2** (Nov 24, 2025)
- Fix: N+1 query in integrity API (1300x faster)
- Rename: /documents/completeness → /documents/integrity

**v1.6.1** (Nov 23, 2025)
- Fix: YARA is_valid logic bug

**v1.6.0** (Nov 22, 2025)
- Add: Security REST API with background scanning
- Add: Parallel scanning (8 workers, ~100x faster)
- Add: Scan result caching by file hash
- Enable: Malware detection by default

**v1.5.0** (Nov 20, 2025)
- Add: Advanced malware detection (ClamAV + YARA + hash blacklist)
- Add: Three-layer security validation

**v1.4.0** (Nov 18, 2025)
- Add: Quarantine system for dangerous files
- Add: Automatic quarantine on CRITICAL threats

**v1.3.0** (Nov 15, 2025)
- Add: Rejection tracking in database
- Change: Validation action default warn → reject

**v1.2.0** (Nov 12, 2025)
- Add: File type validation (magic bytes, executables)
- Add: Archive bomb detection
- Add: Extension mismatch detection

**v1.1.0** (Nov 10, 2025)
- Add: Document completeness verification
- Add: PDF integrity validation (5-point system)
- Add: Self-healing startup (orphan repair)

**v1.0.0** (Jan 2025)
- Initial public release
- Production-ready async architecture
- 445 tests passing

---

## Support

- **Documentation:** [docs/](../../docs/)
- **Issues:** GitHub Issues
- **Contact:** horoshi@katanaquant.com
