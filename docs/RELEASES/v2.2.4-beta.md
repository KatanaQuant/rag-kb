# v2.2.4-beta Release Notes

**Release Date**: 2025-12-07
**Previous Stable**: v2.2.0-beta (deprecated - see below)

---

## Overview

This release fixes all critical issues discovered in v2.2.0-beta's vectorlite HNSW migration.

**If you're on v2.2.0-beta, v2.2.1, or v2.2.2 - upgrade immediately.**

---

## Highlights

- **92.3% search accuracy** (was 73.1% in v2.2.0-beta)
- **All HNSW bugs fixed** (5 distinct issues - see [HNSW postmortem](https://github.com/KatanaQuant/rag-kb/blob/main/docs/postmortem-vectorlite-hnsw-complete.md))
- **Query accuracy improvements** (title boosting + ef=150 - see [accuracy investigation](https://github.com/KatanaQuant/rag-kb/blob/main/docs/postmortem-query-accuracy-investigation.md))
- **Comprehensive Maintenance API** (8 new endpoints)
- **Stable under concurrent operations** (no more index corruption)

---

## Breaking Changes

None from v2.2.0-beta.

---

## What's Fixed

### Critical: HNSW Index Issues

| Bug | Issue | Impact |
|-----|-------|--------|
| 1 | HNSW index not persisting | Data loss on restart |
| 2 | Race condition between stores | Documents overwriting each other |
| 3 | Delete cascade missing | Orphan embeddings polluting search |
| 4 | Default ef=10 (~31% recall) | **73.1% accuracy instead of 92.3%** |
| 5 | Per-write flush corruption | 0-byte index during concurrent ops |

See [Postmortem: Vectorlite HNSW Migration Issues](../postmortem-vectorlite-hnsw-complete.md) for full technical analysis.

### Query Accuracy Improvements

- **HNSW ef_search=150** (was 10) - ~95% recall vs 31%
- **Title boosting** for book queries - filenames help match
- **rank_bm25** replaces FTS5 boolean matching - probabilistic scoring
- **RRF k=20** for better top-result differentiation

### Maintenance API (NEW)

8 new endpoints for database health and repair:

| Endpoint | Purpose |
|----------|---------|
| `GET /api/maintenance/verify-integrity` | Check database health |
| `POST /api/maintenance/cleanup-orphans` | Remove orphan embeddings |
| `POST /api/maintenance/rebuild-hnsw` | Rebuild HNSW index (~55s) |
| `POST /api/maintenance/rebuild-fts` | Rebuild FTS5 index |
| `POST /api/maintenance/repair-indexes` | Rebuild both indexes |
| `POST /api/maintenance/rebuild-embeddings` | Full re-embed all docs |
| `POST /api/maintenance/partial-rebuild` | Re-embed by ID range |
| `POST /api/maintenance/reindex-path` | Re-index specific file/dir |

### Stability Improvements

- Thread-safe database operations
- Unified storage architecture
- Periodic HNSW flush (every 5 min)
- Graceful shutdown persistence

---

## Deprecated Releases

**v2.2.0-beta, v2.2.1, v2.2.2** have critical bugs:

| Version | Issues |
|---------|--------|
| v2.2.0-beta | Data loss, race conditions, 31% HNSW recall |
| v2.2.1 | Partial fix only - still had accuracy issues |
| v2.2.2 | Missing accuracy fix (ef=10 still default) |

**Upgrade to v2.2.4-beta immediately.**

---

## Migration Guide

### Upgrading from v2.x (v2.0.0-beta through v2.2.2)

These versions have critical bugs. Upgrade immediately.

**Issues in v2.x versions:**

| Version | Bug | Impact |
|---------|-----|--------|
| v2.2.0-beta | HNSW not persisting, race conditions | Data loss on restart |
| v2.2.0-beta | Default ef=10 (~31% recall) | Search returning wrong results |
| v2.2.1 | Partial persistence fix | Still had accuracy issues |
| v2.2.2 | FTS bug fixed | Accuracy still broken (ef=10) |

**Upgrade steps:**

```bash
# 1. Stop container gracefully (important for data preservation)
docker-compose stop

# 2. Get latest code
git fetch --tags
git checkout v2.2.4-beta

# 3. Rebuild and start
docker-compose build --no-cache
docker-compose up -d

# 4. Wait for startup (check logs)
docker-compose logs -f rag-api

# 5. Rebuild HNSW index (REQUIRED - fixes accuracy issues)
curl -X POST http://localhost:8000/api/maintenance/rebuild-hnsw \
  -H "Content-Type: application/json" \
  -d '{"dry_run": false}'

# 6. Clean up orphan embeddings (if you used DELETE in v2.x)
curl -X POST http://localhost:8000/api/maintenance/cleanup-orphans \
  -H "Content-Type: application/json" \
  -d '{"dry_run": false}'

# 7. Verify integrity
curl http://localhost:8000/api/maintenance/verify-integrity | jq
```

Expected output from verify-integrity:
```json
{
  "healthy": true,
  "issues": [],
  "table_counts": {"documents": 1634, "chunks": 51544, "vec_chunks": 51544}
}
```

---

### Upgrading from v1.9.x

v2.x uses vectorlite HNSW instead of sqlite-vec, providing 120x faster queries.

**Breaking changes from v1.9.x:**

| Change | Before | After |
|--------|--------|-------|
| Knowledge base directory | `knowledge_base/` | `kb/` |
| License | Unlicense | CC BY-NC 4.0 |
| Vector storage | sqlite-vec | vectorlite HNSW |

**Upgrade steps:**

```bash
# 1. Backup your database
cp data/rag.db data/rag.db.backup-v1.9.x

# 2. Get v2.2.4-beta
git fetch --tags
git checkout v2.2.4-beta

# 3. Move knowledge base if needed
mv knowledge_base kb

# 4. Rebuild container
docker-compose build --no-cache
docker-compose up -d

# 5. Run vectorlite migration (one-time, ~78s for 60K vectors)
docker exec rag-api python /app/ingestion/vector_migration.py /app/data/rag.db 1024

# 6. Verify
curl http://localhost:8000/api/maintenance/verify-integrity | jq
```

**Note**: The migration script creates the vectorlite HNSW index from existing sqlite-vec embeddings. This is a one-time operation.

---

### Troubleshooting Migration Issues

**Search returns 0 results after upgrade:**
```bash
# Rebuild HNSW index
curl -X POST http://localhost:8000/api/maintenance/rebuild-hnsw \
  -H "Content-Type: application/json" -d '{"dry_run": false}'
```

**Integrity check shows orphan chunks:**
```bash
# Clean up orphans
curl -X POST http://localhost:8000/api/maintenance/cleanup-orphans \
  -H "Content-Type: application/json" -d '{"dry_run": false}'
```

**Container won't start:**
```bash
# Check logs
docker-compose logs rag-api

# If index corrupted, delete and rebuild
rm data/vec_chunks.idx
docker-compose restart rag-api
curl -X POST http://localhost:8000/api/maintenance/rebuild-hnsw \
  -H "Content-Type: application/json" -d '{"dry_run": false}'
```

---

## Known Limitations

| Limitation | Impact | Workaround |
|------------|--------|------------|
| vectorlite lacks WAL | Up to 5 min data loss on crash | Run `rebuild-hnsw` to recover |
| Code file queries | 33% accuracy for .py/.ipynb | Known limitation, contextual embeddings planned |

**Planned**: pgvector migration in v2.3.0 for full ACID compliance.

---

## Configuration

### Enabled

| Setting | Value | Purpose |
|---------|-------|---------|
| HNSW_EF_SEARCH | 150 | ~95% recall |
| HYBRID_SEARCH_ENABLED | true | Vector + keyword |
| TITLE_BOOST_ENABLED | true | Filename matching |
| RRF k | 20 | Result ranking |
| Periodic HNSW flush | 300s | Crash recovery |

### Disabled

| Setting | Reason |
|---------|--------|
| RERANKING_ENABLED | No improvement over title boosting |
| QUERY_EXPANSION_ENABLED | +10x latency without accuracy gain |

---

## Benchmark Results

| Version | Usable Accuracy | Latency |
|---------|-----------------|---------|
| v1.9.1 (sqlite-vec) | 84.6% | 60,932ms |
| v2.2.0-beta (ef=10) | 73.1% | ~500ms |
| **v2.2.4-beta (ef=150)** | **92.3%** | **553ms** |

v2.2.4-beta exceeds the v1.9.1 baseline while maintaining 120x faster queries.

---

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for complete version history.
