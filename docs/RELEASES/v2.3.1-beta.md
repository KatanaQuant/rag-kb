# v2.3.1-beta Release Notes

**Release Date**: 2025-12-10
**Previous Version**: v2.3.0-beta

---

## Overview

This patch release improves the robustness of model loading during container startup for ALL model caches. It addresses container restart loops caused by transient network errors, stale lock files, and permission issues.

**Key improvements:**
- Retry logic with exponential backoff for model downloads
- Automatic cleanup of stale lock files for ALL caches (HuggingFace, Docling, EasyOCR, DeepSearch GLM)
- First-time setup script for cache directory initialization

---

## Highlights

| Issue | Before (v2.3.0) | After (v2.3.1) |
|-------|-----------------|----------------|
| Network timeout during model download | Container crash loop | Retries 3x with backoff |
| Stale `.lock` files | Container hangs indefinitely | Auto-cleaned on startup |
| Missing cache directories | Permission errors | Created by entrypoint |
| First-time setup | Manual troubleshooting | `setup-cache.sh` script |

---

## What's Fixed

### Model Loading Retry Logic

The `ModelLoader` class now implements exponential backoff:

```python
# Retry delays: 5s, 10s, 20s
MAX_RETRIES = 3
BASE_DELAY = 5  # seconds
delay = BASE_DELAY * (2 ** attempt)
```

This handles:
- DNS resolution failures
- HuggingFace Hub timeouts
- Network interruptions during download

### Stale Lock File Cleanup

Container entrypoint now cleans up stale lock files from ALL model caches:

```bash
# In docker-entrypoint.sh - clean stale locks (>5 min old)
find /home/appuser/.cache/huggingface -name "*.lock" -mmin +5 -delete 2>/dev/null || true
find /home/appuser/.cache/docling -name "*.lock" -mmin +5 -delete 2>/dev/null || true
find /home/appuser/.EasyOCR -name "*.lock" -mmin +5 -delete 2>/dev/null || true
find /app/.cache/deepsearch_glm -name "*.lock" -mmin +5 -delete 2>/dev/null || true
```

**Caches covered:**
| Cache | Models |
|-------|--------|
| HuggingFace | Embedding models (SentenceTransformer) |
| Docling | PDF processing models |
| EasyOCR | Text detection models |
| DeepSearch GLM | Graph language models |

This prevents hangs when a previous container was killed during model download.

### Cache Directory Initialization

The entrypoint ensures all cache directories exist with correct permissions:

```bash
mkdir -p /home/appuser/.cache/huggingface/hub
mkdir -p /home/appuser/.cache/docling
mkdir -p /home/appuser/.EasyOCR
mkdir -p /app/.cache/deepsearch_glm
```

---

## What's New

### setup-cache.sh Script

New script for first-time setup:

```bash
./scripts/setup-cache.sh
```

This script:
1. Creates all required cache directories (huggingface, docling, easyocr, deepsearch_glm, clamav, rapidocr, query_expansion, ollama)
2. Cleans stale lock files from all model caches
3. Sets correct permissions for bind mount compatibility

### Updated QUICK_START.md

First-time setup instructions now include:
- Cache directory preparation
- Troubleshooting for common startup issues
- Offline mode configuration (`HF_HUB_OFFLINE=1`)

---

## Upgrade Guide

### From v2.3.0-beta

No migration required - just pull and restart:

```bash
git fetch --tags
git checkout v2.3.1-beta
docker-compose down
docker-compose up -d
```

### From v2.2.x

Follow the [v2.3.0-beta migration guide](v2.3.0-beta.md#migration-guide) first, then upgrade to v2.3.1-beta.

---

## Configuration

### Environment Variables

| Variable | Default | Purpose |
|----------|---------|---------|
| HF_HUB_OFFLINE | 0 | Set to 1 if model already cached |
| HF_HOME | /root/.cache/huggingface | HuggingFace cache location |

### Offline Mode

If your model is already cached, skip network checks:

```yaml
# docker-compose.yml
rag-api:
  environment:
    HF_HUB_OFFLINE: 1
```

---

## Files Changed

| File | Change |
|------|--------|
| `api/operations/model_loader.py` | New file - retry logic |
| `api/startup/phases/component_phase.py` | Use ModelLoader |
| `docker-entrypoint.sh` | Lock file cleanup, cache init |
| `scripts/setup-cache.sh` | New file - first-time setup |
| `QUICK_START.md` | Updated with setup instructions |

---

## Troubleshooting

### Container still crash-looping

```bash
# Check logs for specific error
docker-compose logs rag-api | tail -50

# If "connection refused" or "timeout":
# - Check internet connectivity
# - Try HF_HUB_OFFLINE=1 if model cached

# If permission error:
./scripts/setup-cache.sh
docker-compose down
docker-compose up -d
```

### Model download interrupted

```bash
# Clear partial downloads
docker-compose exec rag-api rm -rf /root/.cache/huggingface/hub/models--*/.no_exist
docker-compose restart rag-api
```

---

## Related Documentation

- [v2.3.0-beta Release Notes](v2.3.0-beta.md) - PostgreSQL migration
- [QUICK_START.md](../../QUICK_START.md) - Setup instructions
- [CHANGELOG.md](../../CHANGELOG.md) - Full version history
