# v1.9.2: Search Performance Backport

**Release Date**: 2025-12-09
**Type**: Performance Release (backport from v2.x)

## Summary

Backports search performance improvements from v2.x to the v1.9.x branch for users who cannot migrate to PostgreSQL.

**Key Improvements:**
- Query latency: **20s → ~2s** (10x faster)
- Search accuracy: **84.6% → ~88-92%** usable

---

## What's New

### NumPy In-Memory Vector Search

Replaces sqlite-vec's O(n) row-by-row bruteforce with vectorized numpy operations.

| Metric | v1.9.1 | v1.9.2 |
|--------|--------|--------|
| Query latency | ~20s | **~2s** |
| Startup time | ~21s | ~42s |
| Memory usage | ~50MB | **~250MB** |

**Tradeoff**: Longer startup (loads vectors into RAM) for 10x faster queries.

### BM25 Probabilistic Keyword Search

Replaces FTS5 boolean matching with rank_bm25 probabilistic scoring.

| Behavior | FTS5 (v1.9.1) | BM25 (v1.9.2) |
|----------|---------------|---------------|
| "machine quantum" | Returns nothing (AND) | Returns "machine" matches |
| Multi-term queries | All terms required | Partial matches scored |
| Scoring | Boolean rank | Probabilistic BM25Okapi |

### Title Boosting

Documents whose filename matches query terms are boosted:

| Query | Without Boost | With Boost |
|-------|--------------|------------|
| "24 assets" | Random results | "24_Assets.pdf" ranked first |
| "MAKE exit" | Generic matches | "MAKE.pdf" prioritized |

Boost multipliers: 1.5x (1 match), 2.0x (2 matches), 3.0x (3+ matches)

### RRF k=20 Tuning

Changed Reciprocal Rank Fusion parameter from k=60 to k=20 for better accuracy.

---

## Breaking Changes

None. This is a drop-in upgrade from v1.9.1.

---

## New Dependency

```
rank_bm25>=0.2.2
```

---

## Upgrade Instructions

```bash
# Pull the update
git fetch origin
git checkout v1.9.2

# Rebuild container
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# First startup will take ~42s to load vectors into memory
# Subsequent queries will be ~10x faster
```

---

## Files Changed

| File | Change |
|------|--------|
| `api/requirements.txt` | Added rank_bm25 |
| `api/ingestion/search_repository.py` | Added NumpyVectorSearch class |
| `api/hybrid_search.py` | Added BM25Searcher, title boost, k=20 |
| `api/ingestion/database.py` | Wired up NumpyVectorSearch |
| `tests/test_hybrid_search.py` | Updated tests |

---

## Performance Benchmarks

Tested on 50k vectors (1024 dimensions, Snowflake Arctic embeddings):

| Configuration | Startup | Query | Accuracy |
|---------------|---------|-------|----------|
| v1.9.1 (sqlite-vec) | ~21s | **~20s** | 84.6% |
| v1.9.2 (numpy+BM25) | ~42s | **~2s** | ~88-92% |

---

## Technical Details

### NumpyVectorSearch

```python
class NumpyVectorSearch:
    """
    Loads all vectors into numpy array at startup.
    Uses vectorized np.dot() for O(n) search.
    """
    def _load_all_vectors(self):
        # Load embeddings and normalize
        self._embeddings = np.vstack(embeddings_list)
        norms = np.linalg.norm(self._embeddings, axis=1, keepdims=True)
        self._embeddings = self._embeddings / norms

    def search(self, embedding, top_k):
        # Vectorized cosine similarity
        similarities = np.dot(self._embeddings, query)
        top_indices = np.argsort(similarities)[::-1][:top_k]
```

### BM25Searcher

```python
class BM25Searcher:
    """
    Uses rank_bm25 library for probabilistic scoring.
    Includes title boosting based on filename-query overlap.
    """
    def _get_title_boost(self, file_path, query_tokens):
        # Boost if query matches filename
        overlap = len(filename_tokens & query_token_set)
        return {0: 1.0, 1: 1.5, 2: 2.0}.get(overlap, 3.0)
```

---

## Known Limitations

1. **Memory usage**: ~250MB for 50k vectors. Scale linearly with corpus size.
2. **Startup time**: ~42s initial load. Acceptable for long-running services.
3. **No GPU**: This is a CPU-optimized release. GPU users should use v2.3.0+.

---

## Migration Path

| From | To | Notes |
|------|-----|-------|
| v1.9.1 | v1.9.2 | Drop-in upgrade, no data migration |
| v1.9.2 | v2.3.0+ | Requires PostgreSQL migration |

For PostgreSQL migration, see [v2.3.0-beta release notes](v2.3.0-beta.md).
