# Release v1.9.1

**Release Date:** 2025-11-30

## Summary

Major release introducing MCP HTTP Transport for network-accessible knowledge base queries, Docker image optimization (3.61GB, down from 5.77GB), comprehensive test coverage (759 tests), and significant documentation consolidation.

> **Note**: This release includes all work originally planned for v1.8.x (Docker optimization, MCP network deployment).

---

## New Features

### MCP HTTP Transport (Network Access)
- **HTTP endpoint** at `POST /mcp` for network-accessible MCP server
- **JSON-RPC 2.0** protocol over HTTP with SSE (Server-Sent Events) streaming
- Same tools as stdio MCP: `query_kb`, `list_documents`, `get_kb_stats`
- Documentation for 4 client environments:
  - [Claude Code](MCP_CLAUDE.md)
  - [Cursor](MCP_CODEX.md)
  - [Gemini](MCP_GEMINI.md)
  - [Amp](MCP_AMP.md)
- [SSH tunnel support](MCP_NETWORK.md) for remote device access

### Reindex Endpoint
- **New endpoint**: `POST /document/{path}/reindex`
- Combines DELETE + queue in single atomic operation
- HIGH priority queue placement for immediate processing
- Useful for:
  - E2E testing (validate full pipeline: security scan → chunk → embed → store)
  - Force re-processing after pipeline changes
  - Re-index after manual file edits

### Docker Image Optimization
- **Image size**: 3.61GB (down from 5.77GB, -37%)
- **Layer duplication fixed**: chown optimization eliminates duplicate layers
- **Build time**: ~2-3s with cache (down from ~9m uncached)
- **ClamAV caching**: Virus definitions cached for faster builds

---

## Bug Fixes

### Pipeline Coordinator Fix
- **Issue**: Files stuck in `queued_files` set, silently rejected on re-add
- **Root cause**: `_should_skip_before_queue()` returned True without calling `mark_complete()`
- **Fix**: Added `_mark_file_complete()` call when files are skipped

### EPUB Pipeline Optimization
- EPUBs now bypass chunk/embed/store pipeline entirely
- Only shows `[Convert]` stage (never `[Chunk]`, `[Embed]`, `[Store]`)
- Converted PDF goes through normal pipeline with chunking/embedding
- Benefits:
  - Faster EPUB processing (no pipeline overhead)
  - Cleaner logs
  - Resource efficient

---

## Test Coverage

- **24 new MCP HTTP endpoint tests** (100% passing)
- **Total test suite**: 759 tests passing
- Coverage includes:
  - tools/call, tools/list
  - SSE streaming
  - Error handling
  - Mock isolation fixes for flaky tests

---

## Documentation Updates

### New Guides
- `docs/MCP_AMP.md` - Amp IDE setup guide
- `docs/MCP_NETWORK.md` - Remote device access guide

### Consolidated Docs
| Document | Change |
|----------|--------|
| ROADMAP.md | 806→200 lines (decision log moved to internal) |
| KNOWN_ISSUES.md | Reduced to user-facing summaries |
| DEVELOPMENT.md | 806→179 lines (advanced workflows moved to internal) |
| MCP_CLAUDE.md | Enhanced with HTTP transport examples |
| MCP_CODEX.md | Enhanced with HTTP transport examples |
| MCP_GEMINI.md | Enhanced with HTTP transport examples |
| mcp-server/README.md | Consolidated stdio + HTTP documentation |

### Internal Planning
- Consolidated 17 files → 6 files
- Created GPU_INFRASTRUCTURE.md (merged 3 files)
- Created PERFORMANCE_OPTIMIZATION.md (merged 2 files)

---

## E2E Validation

All file types successfully validated through the full pipeline:

| Type | File | Chunks |
|------|------|--------|
| .py | randompriceexample.py | 1 |
| .go | context.go | 3 |
| .ipynb | asimpletradingrule.ipynb | 3 |
| .pdf | The Little Go Book | 86 |
| .epub | Tidy First - Kent Beck.pdf | 105 |
| .md | backtesting.md | 225 |

Security validation: EICAR test file correctly detected and quarantined.

---

## System Health

| Metric | Value |
|--------|-------|
| Production Ready | Yes |
| Test Coverage | 759 tests passing |
| Docker Image | 3.61GB |
| MCP Endpoints | stdio + HTTP |
| Documents Indexed | 1,643 |
| Chunks Stored | 52,645 |

---

## Upgrade Notes

No breaking changes. Upgrade by pulling the latest image:

```bash
docker-compose down
docker-compose pull
docker-compose up -d
```

### New Environment Variables (Optional)
None required for this release.

